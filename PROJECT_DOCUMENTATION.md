# Synapse Project Documentation

This document provides a detailed overview of the Synapse project, its technical architecture, control flow, and a step-by-step guide to running the application.

## 1. Project Overview

The Synapse project is a web application designed for automated content generation for social media. It consists of a **React frontend** and a **Node.js (Express)** backend.

The core functionality allows users to sign up, manage a business profile, and generate advertising content, which includes text generated by Google Gemini and images from Hugging Face, subsequently stored in Cloudinary.

## 2. Technical Architecture

### 2.1. Backend

The backend is a Node.js application using the Express framework.

**Key Dependencies:**
- `express`: Web server framework.
- `@supabase/supabase-js`: For user authentication and database interactions.
- `@google/generative-ai`: To interact with the Google Gemini API for text generation.
- `axios`: For making HTTP requests to third-party APIs (like Hugging Face).
- `cloudinary`: For image uploads.
- `cors`, `dotenv`, `morgan`: Standard middleware for handling cross-origin requests, environment variables, and logging.

#### 2.1.1. Entry Point (`backend/index.js`)

The application's entry point is `backend/index.js`. It performs the following actions:
1.  **Initializes Services**: Calls `initAI()` from `aiService.js` and `initCloudinary()` from `cloudinaryService.js` to configure these services with credentials from environment variables.
2.  **Sets up Middleware**:
    - `cors`: Enables Cross-Origin Resource Sharing.
    - `express.json()`: Parses incoming JSON payloads.
    - `morgan`: Sets up request logging for development.
3.  **Mounts Routes**: It imports and mounts the various route handlers:
    - `/api/auth`: `authRoutes.js`
    - `/api/business`: `businessRoutes.js`
    - `/api/content`: `contentRoutes.js`
    - `/api/meta`: `meta_routes.js`
4.  **Starts Server**: It starts the Express server, listening on the port defined in the environment variables.

#### 2.1.2. Authentication (`backend/middleware/authMiddleware.js`)

Authentication is handled via JSON Web Tokens (JWTs) provided by Supabase.
- The `protect` middleware is used to secure specific routes.
- It extracts the JWT from the `Authorization` header.
- It uses `supabase.auth.getUser(jwt)` to validate the token and retrieve the authenticated user.
- If the user is valid, their information is attached to the `req` object for use in downstream controllers.

### 2.2. Frontend

The frontend is a modern web application built with **React** and **Vite**.
- **`src/main.jsx`**: The entry point for the React application, rendering the `<App />` component into the DOM.
- **`src/App.jsx`**: The root component of the application.
- **`vite.config.js`**: Configuration for the Vite build tool.

The frontend is responsible for all user interactions, state management, and communication with the backend API.

## 3. Control Flow

### 3.1. User Signup and Login

1.  **Request**: The user signs up via the frontend, which sends a request to **`POST /api/auth/signup`**.
2.  **Controller**: `authRoutes.js` receives the request.
3.  **Supabase**: It calls `supabase.auth.signUp()` with the user's email and password.
4.  **Business Creation**: Upon successful signup, a new business profile is created in the database. **This is a critical side effect to note.**
5.  **Response**: A user session (including a JWT) is returned to the client.
6.  **Login**: For subsequent logins (`POST /api/auth/login`), the flow is similar but uses `supabase.auth.signInWithPassword()`.

### 3.2. Core Feature: Ad Content Generation

This is the main workflow of the application, handled by `contentRoutes.js`.

**Route**: `POST /api/content/generate-ad` (protected route)

1.  **Get Business Profile**: It first retrieves the business profile from the database.
    - **Architectural Flaw**: As noted by the `codebase_investigator`, the code at `businessRoutes.js` assumes a single business exists (`limit(1).maybeSingle()`) and does not scope the query to the authenticated user. This is a significant data integrity risk in a multi-user system.
2.  **Generate Post Content**:
    - It calls `generatePostContent()` from `aiService.js`.
    - This function sends a structured prompt (including business details and user input) to the **Google Gemini API**.
    - The generated text is returned.
3.  **Generate Image**:
    - It calls `generateImage()` from `aiService.js`.
    - This function sends a prompt to the **Hugging Face image generation API**.
    - The generated image is returned (typically as a buffer).
4.  **Upload Image**:
    - The image buffer is passed to `uploadImage()` in `cloudinaryService.js`.
    - This uploads the image to Cloudinary, which returns a secure URL.
5.  **Save to Database**: The generated text content and the Cloudinary image URL are saved to the `posts` table in the database, associated with the business.
6.  **Response**: The final generated post (text and image URL) is sent back to the client.

### 3.3. Meta (Facebook/Instagram) Integration

- **Route**: `GET /api/meta/connect`
- **Controller**: This route in `meta_routes.js` delegates to the `connectMetaAccounts` function in `metaController.js`.
- **Functionality**: The purpose appears to be initiating an OAuth flow or API key exchange with Meta's services, but the implementation details were not fully investigated.

## 4. Step-by-Step Guide to Run the Project

### Prerequisites

- Node.js and npm installed.
- Access to Supabase, Google AI, Hugging Face, and Cloudinary services.

### Backend Setup

1.  **Navigate to the backend directory**:
    ```bash
    cd backend
    ```
2.  **Install dependencies**:
    ```bash
    npm install
    ```
3.  **Create a `.env` file**: Create a file named `.env` in the `backend` directory and add the following environment variables with your credentials:
    ```
    PORT=3001
    SUPABASE_URL=your_supabase_url
    SUPABASE_KEY=your_supabase_anon_key
    GEMINI_API_KEY=your_gemini_api_key
    CLOUDINARY_CLOUD_NAME=your_cloudinary_cloud_name
    CLOUDINARY_API_KEY=your_cloudinary_api_key
    CLOUDINARY_API_SECRET=your_cloudinary_api_secret
    HF_TOKEN=your_hugging_face_token
    ```
4.  **Start the backend server**:
    ```bash
    npm start
    ```
    The backend will be running at `http://localhost:3001`.

### Frontend Setup

1.  **Navigate to the frontend directory**:
    ```bash
    cd frontend
    ```
2.  **Install dependencies**:
    ```bash
    npm install
    ```
3.  **Start the frontend development server**:
    ```bash
    npm run dev
    ```
    The frontend will be accessible at `http://localhost:5173` (or another port if 5173 is busy).

## 5. Key Architectural Issue

The most critical issue identified is in `backend/routes/businessRoutes.js`. The logic to fetch a business profile is:

```javascript
const { data, error } = await supabase.from('business').select('*').limit(1).maybeSingle();
```

This fetches the *first* business it finds in the database, not the one belonging to the currently authenticated user. In a multi-user environment, this will lead to users seeing and modifying each other's data.

**Recommendation**: This must be fixed by associating businesses with user IDs and using the authenticated user's ID to fetch the correct profile. For example:

```javascript
// In a protected route where req.user is available
const { data, error } = await supabase.from('business').select('*').eq('user_id', req.user.id).single();
```
